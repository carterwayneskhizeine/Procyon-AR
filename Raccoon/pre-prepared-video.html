<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ Pre-prepared Video Stream - åˆæˆç”»é¢æ˜¾ç¤ºå™¨</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        #compositeCanvas {
            max-width: 100vw;
            max-height: 100vh;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #info-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            border-left: 4px solid #FFD700;
        }

        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
        }

        .control-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }

        input[type="range"] {
            width: 200px;
        }

        button {
            background: #FFD700;
            color: #000;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
        }

        button:hover {
            background: #FFA500;
        }

        #status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            z-index: 1000;
        }

        .error {
            color: #ff6b6b;
        }

        .success {
            color: #4ecdc4;
        }

        .warning {
            color: #ffa726;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="compositeCanvas"></canvas>
    </div>

    <div id="info-panel">
        <h3 style="margin: 0 0 10px 0; color: #FFD700;">ğŸ¬ åˆæˆç”»é¢æ˜¾ç¤ºå™¨</h3>
        <div><strong>çŠ¶æ€:</strong> <span id="connectionStatus">ç­‰å¾…è¿æ¥...</span></div>
        <div><strong>åˆ†è¾¨ç‡:</strong> <span id="resolution">-</span></div>
        <div><strong>å¸§ç‡:</strong> <span id="fps">0</span> FPS</div>
        <div><strong>æ•°æ®æº:</strong> <span id="dataSource">WebSocket</span></div>
        <div><strong>åˆæˆæ¨¡å¼:</strong> <span id="compositeMode">å®æ—¶åˆæˆ</span></div>
    </div>

    <div id="controls">
        <h4 style="margin: 0 0 10px 0; color: #FFD700;">æ˜¾ç¤ºæ§åˆ¶</h4>
        
        <div class="control-group">
            <label>ç”»é¢ç¼©æ”¾: <span id="scaleValue">100%</span></label>
            <input type="range" id="scaleSlider" min="50" max="200" value="100">
        </div>

        <div class="control-group">
            <label>äº®åº¦è°ƒèŠ‚: <span id="brightnessValue">100%</span></label>
            <input type="range" id="brightnessSlider" min="50" max="150" value="100">
        </div>

        <div class="control-group">
            <label>å¯¹æ¯”åº¦: <span id="contrastValue">100%</span></label>
            <input type="range" id="contrastSlider" min="50" max="150" value="100">
        </div>

        <div class="control-group">
            <button id="fullscreenBtn">å…¨å±æ˜¾ç¤º</button>
            <button id="saveFrameBtn">ä¿å­˜å½“å‰å¸§</button>
        </div>

        <div class="control-group">
            <button id="resetBtn">é‡ç½®è®¾ç½®</button>
            <button id="reconnectBtn">é‡æ–°è¿æ¥</button>
        </div>
    </div>

    <div id="status">
        <div id="statusText">å‡†å¤‡æ¥æ”¶åˆæˆç”»é¢...</div>
        <div id="errorLog"></div>
    </div>

    <script>
        class CompositeVideoReceiver {
            constructor() {
                this.canvas = document.getElementById('compositeCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.websocket = null;
                this.isConnected = false;
                this.frameCount = 0;
                this.startTime = Date.now();
                this.scale = 1.0;
                this.brightness = 1.0;
                this.contrast = 1.0;
                
                this.initializeUI();
                this.connectToSource();
                this.setupControls();
            }

            initializeUI() {
                // è®¾ç½®ç”»å¸ƒåˆå§‹å°ºå¯¸
                this.canvas.width = 640;
                this.canvas.height = 480;
                
                // æ˜¾ç¤ºç­‰å¾…ç”»é¢
                this.drawWaitingScreen();
            }

            drawWaitingScreen() {
                this.ctx.fillStyle = '#1a1a1a';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.ctx.fillStyle = '#FFD700';
                this.ctx.font = '24px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText('ğŸ¬ ç­‰å¾…åˆæˆç”»é¢...', this.canvas.width / 2, this.canvas.height / 2 - 20);
                
                this.ctx.fillStyle = '#888';
                this.ctx.font = '14px Arial';
                this.ctx.fillText('è¯·ç¡®ä¿ index-pure-texture.html æ­£åœ¨è¿è¡Œ', this.canvas.width / 2, this.canvas.height / 2 + 20);
            }

            connectToSource() {
                try {
                    // è¿æ¥åˆ° WebSocket æœåŠ¡å™¨æ¥æ”¶åˆæˆç”»é¢
                    this.websocket = new WebSocket('ws://localhost:3002?type=receiver');
                    
                    this.websocket.onopen = () => {
                        console.log('âœ… WebSocket è¿æ¥æˆåŠŸ');
                        this.isConnected = true;
                        this.updateStatus('å·²è¿æ¥', 'success');
                        document.getElementById('connectionStatus').textContent = 'å·²è¿æ¥';
                        document.getElementById('connectionStatus').className = 'success';
                    };

                    this.websocket.onmessage = (event) => {
                        this.handleCompositeFrame(event.data);
                    };

                    this.websocket.onclose = () => {
                        console.log('âŒ WebSocket è¿æ¥æ–­å¼€');
                        this.isConnected = false;
                        this.updateStatus('è¿æ¥æ–­å¼€', 'error');
                        document.getElementById('connectionStatus').textContent = 'è¿æ¥æ–­å¼€';
                        document.getElementById('connectionStatus').className = 'error';
                        
                        // 5ç§’åè‡ªåŠ¨é‡è¿
                        setTimeout(() => {
                            if (!this.isConnected) {
                                this.connectToSource();
                            }
                        }, 5000);
                    };

                    this.websocket.onerror = (error) => {
                        console.error('âŒ WebSocket é”™è¯¯:', error);
                        this.updateStatus('è¿æ¥é”™è¯¯', 'error');
                    };

                } catch (error) {
                    console.error('âŒ è¿æ¥å¤±è´¥:', error);
                    this.updateStatus('è¿æ¥å¤±è´¥: ' + error.message, 'error');
                    
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ HTTP è½®è¯¢
                    this.startHttpPolling();
                }
            }

            startHttpPolling() {
                console.log('ğŸ”„ å¯åŠ¨ HTTP è½®è¯¢æ¨¡å¼...');
                this.updateStatus('ä½¿ç”¨ HTTP è½®è¯¢æ¨¡å¼', 'warning');
                
                const pollInterval = setInterval(async () => {
                    try {
                        const response = await fetch('http://localhost:3001/api/get-composite-frame');
                        if (response.ok) {
                            const blob = await response.blob();
                            this.handleCompositeFrame(blob);
                        }
                    } catch (error) {
                        console.warn('HTTP è½®è¯¢å¤±è´¥:', error);
                    }
                }, 33); // ~30 FPS
            }

            handleCompositeFrame(data) {
                try {
                    // å¤„ç†æ¥æ”¶åˆ°çš„åˆæˆç”»é¢æ•°æ®
                    const img = new Image();
                    
                    img.onload = () => {
                        // æ›´æ–°ç”»å¸ƒå°ºå¯¸ï¼ˆå¦‚æœéœ€è¦ï¼‰
                        if (this.canvas.width !== img.width || this.canvas.height !== img.height) {
                            this.canvas.width = img.width;
                            this.canvas.height = img.height;
                            document.getElementById('resolution').textContent = `${img.width}x${img.height}`;
                        }

                        // åº”ç”¨å›¾åƒå¤„ç†æ•ˆæœ
                        this.ctx.filter = `brightness(${this.brightness}) contrast(${this.contrast})`;
                        
                        // è®¡ç®—é€‚åº”å±å¹•çš„å°ºå¯¸ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
                        const screenWidth = window.innerWidth;
                        const screenHeight = window.innerHeight;
                        const imageAspect = img.width / img.height;
                        const screenAspect = screenWidth / screenHeight;
                        
                        let canvasWidth, canvasHeight;
                        if (imageAspect > screenAspect) {
                            // å›¾ç‰‡æ›´å®½ï¼Œä»¥å®½åº¦ä¸ºå‡†
                            canvasWidth = screenWidth;
                            canvasHeight = screenWidth / imageAspect;
                        } else {
                            // å›¾ç‰‡æ›´é«˜ï¼Œä»¥é«˜åº¦ä¸ºå‡†
                            canvasHeight = screenHeight;
                            canvasWidth = screenHeight * imageAspect;
                        }
                        
                        // åº”ç”¨ç”¨æˆ·è®¾ç½®çš„ç¼©æ”¾
                        canvasWidth *= this.scale;
                        canvasHeight *= this.scale;
                        
                        // æ›´æ–°ç”»å¸ƒå°ºå¯¸ä¸ºé€‚åº”å±å¹•çš„å°ºå¯¸
                        this.canvas.width = canvasWidth;
                        this.canvas.height = canvasHeight;
                        
                        // ç»˜åˆ¶åˆæˆç”»é¢ï¼ˆå¡«æ»¡æ•´ä¸ªç”»å¸ƒï¼Œå·¦å³ç¿»è½¬ï¼‰
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        
                        // ä¿å­˜å½“å‰å˜æ¢çŠ¶æ€
                        this.ctx.save();
                        
                        // åº”ç”¨æ°´å¹³ç¿»è½¬å˜æ¢
                        this.ctx.scale(-1, 1);
                        this.ctx.translate(-canvasWidth, 0);
                        
                        // ç»˜åˆ¶ç¿»è½¬åçš„ç”»é¢
                        this.ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
                        
                        // æ¢å¤å˜æ¢çŠ¶æ€
                        this.ctx.restore();
                        
                        // é‡ç½®æ»¤é•œ
                        this.ctx.filter = 'none';
                        
                        // æ›´æ–°å¸§ç‡è®¡ç®—
                        this.updateFrameRate();
                    };

                    img.onerror = (error) => {
                        console.error('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
                        this.updateStatus('å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                    };

                    // æ ¹æ®æ•°æ®ç±»å‹åŠ è½½å›¾ç‰‡
                    if (data instanceof Blob) {
                        img.src = URL.createObjectURL(data);
                    } else if (typeof data === 'string') {
                        img.src = data; // Base64 æ•°æ®
                    }

                } catch (error) {
                    console.error('âŒ å¤„ç†åˆæˆç”»é¢å¤±è´¥:', error);
                    this.updateStatus('å¤„ç†ç”»é¢å¤±è´¥: ' + error.message, 'error');
                }
            }

            updateFrameRate() {
                this.frameCount++;
                const currentTime = Date.now();
                const elapsed = (currentTime - this.startTime) / 1000;
                
                if (elapsed >= 1) {
                    const fps = Math.round(this.frameCount / elapsed);
                    document.getElementById('fps').textContent = fps;
                    
                    // é‡ç½®è®¡æ•°å™¨
                    this.frameCount = 0;
                    this.startTime = currentTime;
                }
            }

            setupControls() {
                // ç¼©æ”¾æ§åˆ¶
                const scaleSlider = document.getElementById('scaleSlider');
                const scaleValue = document.getElementById('scaleValue');
                
                scaleSlider.addEventListener('input', (e) => {
                    this.scale = e.target.value / 100;
                    scaleValue.textContent = e.target.value + '%';
                });

                // äº®åº¦æ§åˆ¶
                const brightnessSlider = document.getElementById('brightnessSlider');
                const brightnessValue = document.getElementById('brightnessValue');
                
                brightnessSlider.addEventListener('input', (e) => {
                    this.brightness = e.target.value / 100;
                    brightnessValue.textContent = e.target.value + '%';
                });

                // å¯¹æ¯”åº¦æ§åˆ¶
                const contrastSlider = document.getElementById('contrastSlider');
                const contrastValue = document.getElementById('contrastValue');
                
                contrastSlider.addEventListener('input', (e) => {
                    this.contrast = e.target.value / 100;
                    contrastValue.textContent = e.target.value + '%';
                });

                // å…¨å±æŒ‰é’®
                document.getElementById('fullscreenBtn').addEventListener('click', () => {
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        document.documentElement.requestFullscreen();
                    }
                });

                // ä¿å­˜å½“å‰å¸§
                document.getElementById('saveFrameBtn').addEventListener('click', () => {
                    this.saveCurrentFrame();
                });

                // é‡ç½®è®¾ç½®
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.resetSettings();
                });

                // é‡æ–°è¿æ¥
                document.getElementById('reconnectBtn').addEventListener('click', () => {
                    this.reconnect();
                });
            }

            saveCurrentFrame() {
                try {
                    const link = document.createElement('a');
                    link.download = `composite-frame-${Date.now()}.png`;
                    link.href = this.canvas.toDataURL();
                    link.click();
                    
                    this.updateStatus('å½“å‰å¸§å·²ä¿å­˜', 'success');
                } catch (error) {
                    console.error('âŒ ä¿å­˜å¤±è´¥:', error);
                    this.updateStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                }
            }

            resetSettings() {
                this.scale = 1.0;
                this.brightness = 1.0;
                this.contrast = 1.0;
                
                document.getElementById('scaleSlider').value = 100;
                document.getElementById('scaleValue').textContent = '100%';
                document.getElementById('brightnessSlider').value = 100;
                document.getElementById('brightnessValue').textContent = '100%';
                document.getElementById('contrastSlider').value = 100;
                document.getElementById('contrastValue').textContent = '100%';
                
                this.updateStatus('è®¾ç½®å·²é‡ç½®', 'success');
            }

            reconnect() {
                if (this.websocket) {
                    this.websocket.close();
                }
                this.updateStatus('æ­£åœ¨é‡æ–°è¿æ¥...', 'warning');
                setTimeout(() => {
                    this.connectToSource();
                }, 1000);
            }

            updateStatus(message, type = 'info') {
                const statusText = document.getElementById('statusText');
                statusText.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
                statusText.className = type;
                
                console.log(`ğŸ“Š [${type.toUpperCase()}] ${message}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ¬ åˆæˆç”»é¢æ˜¾ç¤ºå™¨å·²å¯åŠ¨');
            const receiver = new CompositeVideoReceiver();
            
            // å…¨å±€é”™è¯¯å¤„ç†
            window.addEventListener('error', (error) => {
                console.error('âŒ å…¨å±€é”™è¯¯:', error);
                receiver.updateStatus('ç³»ç»Ÿé”™è¯¯: ' + error.message, 'error');
            });

            // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    console.log('ğŸ“´ é¡µé¢éšè—ï¼Œæš‚åœæ¥æ”¶');
                } else {
                    console.log('ğŸ“º é¡µé¢æ˜¾ç¤ºï¼Œæ¢å¤æ¥æ”¶');
                    receiver.reconnect();
                }
            });

            // çª—å£å¤§å°å˜åŒ–å¤„ç†
            window.addEventListener('resize', () => {
                // è§¦å‘ç”»é¢é‡æ–°è°ƒæ•´ï¼ˆå¦‚æœæœ‰å½“å‰ç”»é¢çš„è¯ï¼‰
                console.log('ğŸ“ çª—å£å¤§å°å·²æ”¹å˜ï¼Œé‡æ–°è°ƒæ•´ç”»é¢å°ºå¯¸');
            });
        });
    </script>
</body>
</html> 