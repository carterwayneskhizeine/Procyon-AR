<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple Face Points Mapping Test</title>
  <style>
    body { margin: 0; display: flex; flex-direction: column; align-items: center; background:#111;color:#fff;font-family:Arial; padding: 20px;}
    #video { display:block; width:640px; transform: scaleX(-1); border: 2px solid #333; }
    #overlay { position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); pointer-events: none; }
    #controls { margin: 20px 0; }
    .button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
    #log { font-size:14px; margin-top:10px; color: #ddd; max-width: 800px; }
    .status { margin: 10px 0; }
    .error { color: #ff6666; }
    .success { color: #66ff66; }
  </style>
</head>
<body>
  <h2>ğŸ› ï¸ Simple Prototype: Face Points Mapping Test</h2>
  <div style="position: relative; display: inline-block;">
    <video id="video" width="640" height="480" autoplay muted playsinline></video>
    <canvas id="overlay" width="640" height="480"></canvas>
  </div>
  
  <div id="controls">
    <button class="button" onclick="startMapping()">å¼€å§‹æ£€æµ‹</button>
    <button class="button" onclick="showMapping()">æ˜¾ç¤ºæ˜ å°„å¯¹ç…§</button>
    <button class="button" onclick="clearOverlay()">æ¸…é™¤ç”»å¸ƒ</button>
  </div>
  
  <div id="log">
    <div class="status">ç­‰å¾…åˆå§‹åŒ–...</div>
  </div>

  <!-- åªåŠ è½½å¿…è¦çš„åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  
  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const logDiv = document.getElementById('log');
    
    let isRunning = false;
    let currentPoints68 = null;
    let currentPoints71 = null;

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      logDiv.appendChild(div);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    // 68 âœ 71 æ˜ å°„è¡¨ (ä¿®æ­£ç‰ˆ)
    const mapping68to71 = {
      // ä¸‹é¢Œè½®å»“ 0-14 â†’ 0-14 (dlib 17ç‚¹ â†’ clm 15ç‚¹ï¼Œéœ€è¦å‹ç¼©)
      0: 0, 1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, 7: 7, 8: 8,
      9: 9, 10: 10, 11: 11, 12: 12, 13: 13, 14: 14,
      // ä½† dlib æœ‰16ä¸ªç‚¹ (0-16)ï¼Œclmåªæœ‰15ä¸ª (0-14)ï¼Œæ‰€ä»¥å‹ç¼©æ˜ å°„ï¼š
      15: 14, 16: 14, // é‡å¤æœ€åä¸€ä¸ªç‚¹
      
      // å³çœ‰ 15-18 â† dlib 17-21 (5ç‚¹â†’4ç‚¹)
      15: 17, 16: 18, 17: 19, 18: 21, // è·³è¿‡ dlib-20
      
      // å·¦çœ‰ 19-22 â† dlib 22-26 (5ç‚¹â†’4ç‚¹) 
      19: 22, 20: 23, 21: 24, 22: 26, // è·³è¿‡ dlib-25
      
      // å·¦çœ¼å¤–åœˆ 23-26
      23: 36, 24: 37, 25: 39, 26: 40,
      
      // å³çœ¼å¤–åœˆ 28-31 
      28: 42, 29: 44, 30: 43, 31: 47,
      
      // é¼»å­åŒºåŸŸ
      33: 27, // é¼»æ ¹
      34: 31, 35: 32, 36: 33, // é¼»ç¿¼å·¦
      37: 30, // é¼»å°–ä¸‹æ–¹
      38: 35, 39: 34, 40: 35, // é¼»ç¿¼å³ï¼Œé¡ºåºè°ƒæ•´
      42: 31, 43: 35, // é¼»å­”è§’è½
      62: 30, // é¼»å°–ä¸Šæ–¹
      
      // å˜´å·´å¤–è½®å»“ 44-55
      44: 48, 45: 49, 46: 50, 47: 51, 48: 52, 49: 53,
      50: 54, 51: 55, 52: 56, 53: 57, 54: 58, 55: 59,
      
      // å˜´å·´å†…è½®å»“ 56-61
      56: 60, 57: 62, 58: 64, 59: 67, 60: 61, 61: 63,
      
      // å·¦çœ¼ä¸‹æ–¹é¢å¤–ç‚¹ 63-66
      63: 37, 64: 38, 65: 41, 66: 40,
      
      // å³çœ¼ä¸‹æ–¹é¢å¤–ç‚¹ 67-70  
      67: 44, 68: 43, 69: 46, 70: 47
    };

    function convert68to71(pts68) {
      const pts71 = new Array(71);
      
      // ä½¿ç”¨æ˜ å°„è¡¨å¡«å……
      for (let clmIdx = 0; clmIdx < 71; clmIdx++) {
        const dlibIdx = mapping68to71[clmIdx];
        if (dlibIdx !== undefined && pts68[dlibIdx]) {
          pts71[clmIdx] = [pts68[dlibIdx].x, pts68[dlibIdx].y];
        }
      }
      
      // è®¡ç®—ç‰¹æ®Šç‚¹ï¼šçœ¼ä¸­å¿ƒå’Œé¼»æ¢ä¸­ç‚¹
      if (pts68.length >= 48) {
        // å·¦çœ¼ä¸­å¿ƒ (27)
        const leftEye = pts68.slice(36, 42);
        const leftCenter = leftEye.reduce((acc, p) => ({ x: acc.x + p.x, y: acc.y + p.y }), { x: 0, y: 0 });
        pts71[27] = [leftCenter.x / leftEye.length, leftCenter.y / leftEye.length];
        
        // å³çœ¼ä¸­å¿ƒ (32)
        const rightEye = pts68.slice(42, 48);
        const rightCenter = rightEye.reduce((acc, p) => ({ x: acc.x + p.x, y: acc.y + p.y }), { x: 0, y: 0 });
        pts71[32] = [rightCenter.x / rightEye.length, rightCenter.y / rightEye.length];
        
        // é¼»æ¢ä¸­ç‚¹ (41)
        if (pts68[28] && pts68[29]) {
          pts71[41] = [(pts68[28].x + pts68[29].x) / 2, (pts68[28].y + pts68[29].y) / 2];
        }
      }
      
      // å¡«å……æœªå®šä¹‰çš„ç‚¹ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªç‚¹ä½œä¸ºé»˜è®¤å€¼ï¼‰
      for (let i = 0; i < 71; i++) {
        if (!pts71[i] && pts68[0]) {
          pts71[i] = [pts68[0].x, pts68[0].y];
        }
      }
      
      return pts71;
    }

    function drawPoints(points, color, size = 3, label = '') {
      ctx.fillStyle = color;
      points.forEach((point, index) => {
        if (point && typeof point[0] === 'number' && typeof point[1] === 'number') {
          // æ°´å¹³é•œåƒ x åæ ‡
          const mirroredX = overlay.width - point[0];
          const y = point[1];
          
          ctx.beginPath();
          ctx.arc(mirroredX, y, size, 0, Math.PI * 2);
          ctx.fill();
          
          // æ˜¾ç¤ºç‚¹åºå·
          if (label) {
            ctx.fillStyle = 'white';
            ctx.font = '10px Arial';
            ctx.fillText(`${label}${index}`, mirroredX + 5, y - 5);
            ctx.fillStyle = color;
          }
        }
      });
    }

    function clearOverlay() {
      ctx.clearRect(0, 0, overlay.width, overlay.height);
    }

    function showMapping() {
      if (currentPoints68 && currentPoints71) {
        clearOverlay();
        drawPoints(currentPoints68.map(p => [p.x, p.y]), '#00ff00', 2, 'D'); // dlibç»¿è‰²
        drawPoints(currentPoints71, '#ff0000', 2, 'C'); // clmçº¢è‰²
        
        log(`æ˜¾ç¤ºæ˜ å°„å¯¹ç…§ï¼šç»¿è‰²=dlib68ç‚¹ï¼Œçº¢è‰²=clm71ç‚¹`, 'info');
      } else {
        log('æ²¡æœ‰æ£€æµ‹åˆ°äººè„¸ç‚¹ä½', 'error');
      }
    }

    async function initFaceAPI() {
      try {
        log('æ­£åœ¨åŠ è½½ face-api.js æ¨¡å‹...', 'info');
        
        // å°è¯•æœ¬åœ°æ¨¡å‹ï¼Œå¤±è´¥åˆ™ä½¿ç”¨CDN
        try {
          await faceapi.nets.tinyFaceDetector.loadFromUri('../models');
          await faceapi.nets.faceLandmark68TinyNet.loadFromUri('../models');
          log('æœ¬åœ°æ¨¡å‹åŠ è½½æˆåŠŸ', 'success');
        } catch (localError) {
          log('æœ¬åœ°æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨CDNæ¨¡å‹...', 'info');
          const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
          await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
          await faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL);
          log('CDNæ¨¡å‹åŠ è½½æˆåŠŸ', 'success');
        }
        
        return true;
      } catch (error) {
        log(`æ¨¡å‹åŠ è½½å¤±è´¥: ${error.message}`, 'error');
        return false;
      }
    }

    async function initWebcam() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { width: 640, height: 480 }
        });
        video.srcObject = stream;
        await new Promise(resolve => video.onloadedmetadata = resolve);
        log('æ‘„åƒå¤´åˆå§‹åŒ–æˆåŠŸ', 'success');
        return true;
      } catch (error) {
        log(`æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
        return false;
      }
    }

    async function detectAndMap() {
      if (!isRunning) return;
      
      try {
        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
          inputSize: 256,
          scoreThreshold: 0.3
        })).withFaceLandmarks(true);

        clearOverlay();
        
        if (detection) {
          currentPoints68 = detection.landmarks.positions;
          currentPoints71 = convert68to71(currentPoints68);
          
          // ç»˜åˆ¶dlib 68ç‚¹ï¼ˆç»¿è‰²ï¼‰
          drawPoints(currentPoints68.map(p => [p.x, p.y]), '#00ff00', 2);
          
          // ç»˜åˆ¶clm 71ç‚¹ï¼ˆçº¢è‰²å°ç‚¹ï¼‰
          drawPoints(currentPoints71, '#ff0000', 1);
          
          // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
          const confidence = detection.detection.score.toFixed(3);
          ctx.fillStyle = 'yellow';
          ctx.font = '16px Arial';
          ctx.fillText(`æ£€æµ‹ç½®ä¿¡åº¦: ${confidence}`, 10, 30);
          ctx.fillText(`dlib68ç‚¹: ${currentPoints68.length}`, 10, 50);
          ctx.fillText(`clm71ç‚¹: ${currentPoints71.length}`, 10, 70);
        } else {
          ctx.fillStyle = 'red';
          ctx.font = '16px Arial';
          ctx.fillText('æœªæ£€æµ‹åˆ°äººè„¸', 10, 30);
        }
      } catch (error) {
        log(`æ£€æµ‹é”™è¯¯: ${error.message}`, 'error');
      }
      
      requestAnimationFrame(detectAndMap);
    }

    async function startMapping() {
      if (isRunning) {
        isRunning = false;
        log('åœæ­¢æ£€æµ‹', 'info');
        return;
      }
      
      log('å¼€å§‹åˆå§‹åŒ–...', 'info');
      
      const webcamOK = await initWebcam();
      if (!webcamOK) return;
      
      const faceAPIReady = await initFaceAPI();
      if (!faceAPIReady) return;
      
      isRunning = true;
      log('å¼€å§‹å®æ—¶æ£€æµ‹å’Œæ˜ å°„', 'success');
      detectAndMap();
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    window.addEventListener('load', () => {
      log('é¡µé¢åŠ è½½å®Œæˆï¼Œç‚¹å‡»"å¼€å§‹æ£€æµ‹"æŒ‰é’®å¯åŠ¨', 'success');
    });
  </script>
</body>
</html> 